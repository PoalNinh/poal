<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Kết Quả ADS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/10.3.3/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
            background-color: #f3f4f6;
            padding: 10px;
        }

        .sidebar-icon {
            width: 20px;
            height: 20px;
            color: #374151;
            margin-right: 8px;
        }


        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #374151;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-section {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 10px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }

        .filter-section:hover {
            transform: translateY(-2px);
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        .filter-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: #f9fafb;
            color: #374151;
            margin-top: 4px;
        }

        .filter-button {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        #applyFilters {
            background-color: #3b82f6;
            color: #ffffff;
        }

        #applyFilters:hover {
            background-color: #2563eb;
        }

        #resetFilters {
            background-color: #e5e7eb;
            color: #374151;
        }

        #resetFilters:hover {
            background-color: #d1d5db;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <!-- Top Navigation -->
    <nav class="fixed top-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-md z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">ADS Performance Dashboard</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="exportData"
                    class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
                <button id="darkModeToggle"
                    class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition-colors duration-300">
                    <i class="fas fa-moon text-gray-800 dark:text-white"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content with Sidebar -->
    <div class="flex pt-16">
        <!-- Sidebar Filters -->
        <div class="sidebar w-64 fixed left-0 top-16 bottom-0 bg-white dark:bg-gray-800 shadow-sm overflow-y-auto">
            <!-- Header -->
            <div class="sidebar-header border-b dark:border-gray-700">
                <svg class="sidebar-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
                        clip-rule="evenodd" />
                </svg>
                Bộ lọc
            </div>

            <!-- Date Filter -->
            <div class="filter-section">
                <label class="filter-label">Khoảng thời gian</label>
                <select id="dateFilter" class="filter-input">
                    <option value="all">Tất cả ngày</option>
                    <option value="7">7 ngày qua</option>
                    <option value="30">30 ngày qua</option>
                    <option value="90">90 ngày qua</option>
                    <option value="custom">Tùy chỉnh</option>
                </select>

                <div id="customDateRange" class="hidden space-y-2 mt-2">
                    <div>
                        <label class="filter-label">Từ ngày</label>
                        <input type="date" id="startDate" class="filter-input">
                    </div>
                    <div>
                        <label class="filter-label">Đến ngày</label>
                        <input type="date" id="endDate" class="filter-input">
                    </div>
                </div>
            </div>

            <!-- Marketer Filter -->
            <div class="filter-section">
                <label class="filter-label">Marketer</label>
                <select id="marketerFilter" class="filter-input">
                    <option value="">Tất cả Marketer</option>
                </select>
            </div>

            <!-- Traffic Source Filter -->
            <div class="filter-section">
                <label class="filter-label">Traffic Source</label>
                <select id="trafficSourceFilter" class="filter-input">
                    <option value="">Tất cả nguồn</option>
                </select>
            </div>

            <!-- Link Filter -->
            <div class="filter-section">
                <label class="filter-label">Link</label>
                <select id="linkFilter" class="filter-input">
                    <option value="">Tất cả link</option>
                </select>
            </div>

            <!-- Status Filter -->
            <div class="filter-section">
                <label class="filter-label">Trạng thái</label>
                <select id="statusFilter" class="filter-input">
                    <option value="">Tất cả trạng thái</option>
                </select>
            </div>

            <!-- Filter Buttons -->
            <!-- Filter Buttons -->
            <div class="p-3 sticky bottom-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                <div class="flex space-x-2 justify-center">
                    <button id="applyFilters" class="filter-button bg-blue-600 text-white hover:bg-blue-700">
                        <svg class="w-4 h-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
                                clip-rule="evenodd" />
                        </svg>
                        Áp dụng
                    </button>
                    <button id="resetFilters"
                        class="filter-button bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                        <svg class="w-4 h-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                                clip-rule="evenodd" />
                        </svg>
                        Đặt lại
                    </button>
                </div>
            </div>

        </div>

        <!-- Main Content Area -->
        <div class="ml-72 flex-1 p-8">
            <!-- KPI Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Tổng chi phí</h3>
                    <p id="totalCost" class="text-3xl font-bold text-red-500">0 ₫</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Tổng doanh thu</h3>
                    <p id="totalRevenue" class="text-3xl font-bold text-green-500">0 ₫</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Tổng lợi nhuận</h3>
                    <p id="totalProfit" class="text-3xl font-bold text-blue-500">0 ₫</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">ROI trung bình</h3>
                    <p id="averageROI" class="text-3xl font-bold text-purple-500">0%</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Chi phí & Doanh thu theo ngày
                    </h3>
                    <div id="revenueChart" style="height: 300px;"></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Top Marketer</h3>
                    <div id="marketerChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Traffic Source Distribution
                    </h3>
                    <div id="trafficChart" style="height: 300px;"></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Conversion Rate Trend</h3>
                    <div id="cvrChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div id="adPerformanceChart"></div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Chi tiết chiến dịch</h3>
                    <input type="text" id="campaignSearch" placeholder="Tìm kiếm..."
                        class="w-64 p-2 border rounded-md dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>

                <div class="overflow-x-auto">
                    <table id="campaignTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Ad ID
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Marketer
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Traffic Source
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Link
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Cost
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Revenue
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    ROI
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Status
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button id="prevPage"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">Trang
                        trước</button>
                    <span id="pageInfo" class="text-gray-600 dark:text-gray-300"></span>
                    <button id="nextPage"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">Trang
                        sau</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const appId = '171403da-4bac-4fd5-b98f-39fc9658bbc8';
        const accessKey = 'V2-V9Krv-dfHd1-BmyZ0-JPHnA-rVvQa-ku7Kt-EUA1J-V2ONy';
        const region = 'www';

        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Format currency function
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        // API Request function
        async function apiRequest(tableName, action, data) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: action,
                        Properties: {},
                        ...data
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("API Request Error:", error);
                alert("Có lỗi khi tải dữ liệu. Vui lòng thử lại sau.");
                throw error;
            }
        }

        // Fetch data from AppSheet
        async function fetchData() {
            try {
                const response = await apiRequest('Data', 'Find', {
                    Selector: "Filter(Data, true)"
                });
                allData = response;
                filteredData = allData;
                updateDashboard();
                populateFilters();
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }
        // Thêm hàm tính toán dữ liệu cùng kỳ
        function calculatePreviousPeriodData(currentData) {
            if (!currentData || currentData.length === 0) return [];

            // Lấy thời gian từ select box
            const dateRange = document.getElementById('dateFilter').value;

            const currentStartDate = new Date(Math.min(...currentData.map(item => new Date(item.Date))));
            const currentEndDate = new Date(Math.max(...currentData.map(item => new Date(item.Date))));

            let previousStartDate, previousEndDate;

            // Tính khoảng thời gian cho kỳ trước dựa vào dateRange
            switch (dateRange) {
                case '7':
                    previousStartDate = new Date(currentStartDate);
                    previousStartDate.setDate(previousStartDate.getDate() - 7);
                    previousEndDate = new Date(currentEndDate);
                    previousEndDate.setDate(previousEndDate.getDate() - 7);
                    break;
                case '30':
                    previousStartDate = new Date(currentStartDate);
                    previousStartDate.setDate(previousStartDate.getDate() - 30);
                    previousEndDate = new Date(currentEndDate);
                    previousEndDate.setDate(previousEndDate.getDate() - 30);
                    break;
                case '90':
                    previousStartDate = new Date(currentStartDate);
                    previousStartDate.setDate(previousStartDate.getDate() - 90);
                    previousEndDate = new Date(currentEndDate);
                    previousEndDate.setDate(previousEndDate.getDate() - 90);
                    break;
                case 'custom':
                    const startDate = new Date(document.getElementById('startDate').value);
                    const endDate = new Date(document.getElementById('endDate').value);
                    const daysDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
                    previousStartDate = new Date(startDate);
                    previousStartDate.setDate(previousStartDate.getDate() - daysDiff);
                    previousEndDate = new Date(startDate);
                    previousEndDate.setDate(previousEndDate.getDate() - 1);
                    break;
                default:
                    // Trường hợp 'all' hoặc không xác định, lấy kỳ trước bằng với khoảng thời gian hiện tại
                    const periodLength = (currentEndDate - currentStartDate) / (1000 * 60 * 60 * 24);
                    previousStartDate = new Date(currentStartDate);
                    previousStartDate.setDate(previousStartDate.getDate() - periodLength);
                    previousEndDate = new Date(currentEndDate);
                    previousEndDate.setDate(previousEndDate.getDate() - periodLength);
            }

            // Lọc dữ liệu của kỳ trước
            return allData.filter(item => {
                const itemDate = new Date(item.Date);
                return itemDate >= previousStartDate && itemDate <= previousEndDate;
            });
        }

        // Cập nhật hàm updateDashboard để thêm thông tin so sánh
        function updateDashboard() {
            if (!filteredData.length) {
                document.getElementById('totalCost').innerHTML = formatCurrency(0);
                document.getElementById('totalRevenue').innerHTML = formatCurrency(0);
                document.getElementById('totalProfit').innerHTML = formatCurrency(0);
                document.getElementById('averageROI').innerHTML = '0%';
                return;
            }

            const previousPeriodData = calculatePreviousPeriodData(filteredData);

            // Tính toán metrics cho kỳ hiện tại
            const currentMetrics = {
                cost: filteredData.reduce((sum, item) => sum + parseFloat(item['Cost VND'] || 0), 0),
                revenue: filteredData.reduce((sum, item) => sum + parseFloat(item['Revenue VND'] || 0), 0)
            };
            currentMetrics.profit = currentMetrics.revenue - currentMetrics.cost;
            currentMetrics.roi = currentMetrics.cost ? (currentMetrics.profit / currentMetrics.cost * 100) : 0;

            // Tính toán metrics cho kỳ trước
            const previousMetrics = {
                cost: previousPeriodData.reduce((sum, item) => sum + parseFloat(item['Cost VND'] || 0), 0),
                revenue: previousPeriodData.reduce((sum, item) => sum + parseFloat(item['Revenue VND'] || 0), 0)
            };
            previousMetrics.profit = previousMetrics.revenue - previousMetrics.cost;
            previousMetrics.roi = previousMetrics.cost ? (previousMetrics.profit / previousMetrics.cost * 100) : 0;

            // Tính phần trăm thay đổi
            const changes = {
                cost: previousMetrics.cost ? ((currentMetrics.cost - previousMetrics.cost) / previousMetrics.cost * 100) : 0,
                revenue: previousMetrics.revenue ? ((currentMetrics.revenue - previousMetrics.revenue) / previousMetrics.revenue * 100) : 0,
                profit: previousMetrics.profit ? ((currentMetrics.profit - previousMetrics.profit) / previousMetrics.profit * 100) : 0,
                roi: previousMetrics.roi ? (currentMetrics.roi - previousMetrics.roi) : 0
            };

            // Update UI với thông tin chi tiết
            document.getElementById('totalCost').innerHTML = `
        <div class="flex flex-col">
            <span class="text-3xl font-bold text-red-500">${formatCurrency(currentMetrics.cost)}</span>
            <div class="flex items-center text-sm mt-1 ${changes.cost > 0 ? 'text-red-500' : 'text-green-500'}">
                <span class="mr-1">${changes.cost !== 0 ? (changes.cost > 0 ? '▲' : '▼') : '='}</span>
                <span>${Math.abs(changes.cost).toFixed(1)}% so với kỳ trước</span>
            </div>
            <div class="text-xs text-gray-500">Kỳ trước: ${formatCurrency(previousMetrics.cost)}</div>
        </div>
    `;

            document.getElementById('totalRevenue').innerHTML = `
        <div class="flex flex-col">
            <span class="text-3xl font-bold text-green-500">${formatCurrency(currentMetrics.revenue)}</span>
            <div class="flex items-center text-sm mt-1 ${changes.revenue > 0 ? 'text-green-500' : 'text-red-500'}">
                <span class="mr-1">${changes.revenue !== 0 ? (changes.revenue > 0 ? '▲' : '▼') : '='}</span>
                <span>${Math.abs(changes.revenue).toFixed(1)}% so với kỳ trước</span>
            </div>
            <div class="text-xs text-gray-500">Kỳ trước: ${formatCurrency(previousMetrics.revenue)}</div>
        </div>
    `;

            document.getElementById('totalProfit').innerHTML = `
        <div class="flex flex-col">
            <span class="text-3xl font-bold text-blue-500">${formatCurrency(currentMetrics.profit)}</span>
            <div class="flex items-center text-sm mt-1 ${changes.profit > 0 ? 'text-green-500' : 'text-red-500'}">
                <span class="mr-1">${changes.profit !== 0 ? (changes.profit > 0 ? '▲' : '▼') : '='}</span>
                <span>${Math.abs(changes.profit).toFixed(1)}% so với kỳ trước</span>
            </div>
            <div class="text-xs text-gray-500">Kỳ trước: ${formatCurrency(previousMetrics.profit)}</div>
        </div>
    `;

            document.getElementById('averageROI').innerHTML = `
        <div class="flex flex-col">
            <span class="text-3xl font-bold text-purple-500">${currentMetrics.roi.toFixed(2)}%</span>
            <div class="flex items-center text-sm mt-1 ${changes.roi > 0 ? 'text-green-500' : 'text-red-500'}">
                <span class="mr-1">${changes.roi !== 0 ? (changes.roi > 0 ? '▲' : '▼') : '='}</span>
                <span>${Math.abs(changes.roi).toFixed(1)} điểm % so với kỳ trước</span>
            </div>
            <div class="text-xs text-gray-500">Kỳ trước: ${previousMetrics.roi.toFixed(2)}%</div>
        </div>
    `;

            // Update charts và table
            updateCharts();
            updateCampaignTable();

            // Thêm tooltip cho các metrics cards
            const tooltips = {
                totalCost: `
            Kỳ hiện tại: ${formatCurrency(currentMetrics.cost)}
            Kỳ trước: ${formatCurrency(previousMetrics.cost)}
            Thay đổi: ${changes.cost > 0 ? '+' : ''}${changes.cost.toFixed(1)}%
        `,
                totalRevenue: `
            Kỳ hiện tại: ${formatCurrency(currentMetrics.revenue)}
            Kỳ trước: ${formatCurrency(previousMetrics.revenue)}
            Thay đổi: ${changes.revenue > 0 ? '+' : ''}${changes.revenue.toFixed(1)}%
        `,
                totalProfit: `
            Kỳ hiện tại: ${formatCurrency(currentMetrics.profit)}
            Kỳ trước: ${formatCurrency(previousMetrics.profit)}
            Thay đổi: ${changes.profit > 0 ? '+' : ''}${changes.profit.toFixed(1)}%
        `,
                averageROI: `
            Kỳ hiện tại: ${currentMetrics.roi.toFixed(2)}%
            Kỳ trước: ${previousMetrics.roi.toFixed(2)}%
            Thay đổi: ${changes.roi > 0 ? '+' : ''}${changes.roi.toFixed(1)} điểm %
        `
            };

            // Thêm title attribute cho tooltips
            Object.keys(tooltips).forEach(id => {
                document.getElementById(id).setAttribute('title', tooltips[id]);
            });

            // Thêm class để xử lý hover effect
            document.querySelectorAll('.metric-card').forEach(card => {
                card.classList.add('hover:shadow-lg', 'transition-shadow', 'duration-300');
            });
        }


        // Filter functions
        function populateFilters() {
            const marketerFilter = document.getElementById('marketerFilter');
            const sourceFilter = document.getElementById('trafficSourceFilter');
            const statusFilter = document.getElementById('statusFilter');
            const linkFilter = document.getElementById('linkFilter');

            // Clear existing options
            marketerFilter.innerHTML = '<option value="">Tất cả Marketer</option>';
            sourceFilter.innerHTML = '<option value="">Tất cả nguồn</option>';
            statusFilter.innerHTML = '<option value="">Tất cả trạng thái</option>';
            linkFilter.innerHTML = '<option value="">Tất cả link</option>';

            // Get unique values
            const marketers = [...new Set(allData.map(item => item.Marketer))];
            const sources = [...new Set(allData.map(item => item['Traffic Source']))];
            const statuses = [...new Set(allData.map(item => item.Status))];
            const links = [...new Set(allData.map(item => item.Link))];

            // Populate filters
            marketers.sort().forEach(marketer => {
                if (marketer) marketerFilter.add(new Option(marketer, marketer));
            });

            sources.sort().forEach(source => {
                if (source) sourceFilter.add(new Option(source, source));
            });

            statuses.sort().forEach(status => {
                if (status) statusFilter.add(new Option(status, status));
            });

            links.sort().forEach(link => {
                if (link) linkFilter.add(new Option(link, link));
            });
        }

        // Apply filters
        function applyFilters() {
            const marketer = document.getElementById('marketerFilter').value;
            const source = document.getElementById('trafficSourceFilter').value;
            const dateRange = document.getElementById('dateFilter').value;
            const status = document.getElementById('statusFilter').value;
            const linkSearch = document.getElementById('linkFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredData = allData.filter(item => {
                const marketerMatch = !marketer || item.Marketer === marketer;
                const sourceMatch = !source || item['Traffic Source'] === source;
                const statusMatch = !status || item.Status === status;
                const linkMatch = !linkSearch || item.Link === linkSearch;


                // Date filtering
                let dateMatch = true;
                if (dateRange === 'custom' && startDate && endDate) {
                    const itemDate = new Date(item.Date.split(' ')[0]);
                    dateMatch = itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
                } else if (dateRange !== 'custom') {
                    dateMatch = filterByDateRange(item.Date, dateRange);
                }

                return marketerMatch && sourceMatch && dateMatch && statusMatch && linkMatch;
            });

            currentPage = 1;
            updateDashboard();
        }

        // Date range filter helper
        function filterByDateRange(dateString, range) {
            if (!range || range === 'custom' || range === 'all') return true;

            const itemDate = new Date(dateString.split(' ')[0]);
            const today = new Date();
            const rangeDate = new Date(today.getTime() - (parseInt(range) * 24 * 60 * 60 * 1000));
            return itemDate >= rangeDate;
        }

        function createAdPerformanceChart() {
            // Tổng hợp dữ liệu theo Marketer
            const marketerMetrics = filteredData.reduce((acc, item) => {
                const marketer = item.Marketer;
                if (!acc[marketer]) {
                    acc[marketer] = {
                        click1: 0,
                        click3: 0,
                        revenue: 0
                    };
                }
                acc[marketer].click1 += parseFloat(item.Click1 || 0);
                acc[marketer].click3 += parseFloat(item.Click3 || 0);
                acc[marketer].revenue += parseFloat(item.Revenue || 0);
                return acc;
            }, {});

            // Chuyển đổi và sắp xếp dữ liệu theo Revenue
            const chartData = Object.entries(marketerMetrics)
                .map(([marketer, metrics]) => ({
                    marketer: marketer,
                    click1: metrics.click1,
                    click3: metrics.click3,
                    revenue: metrics.revenue
                }))
                .sort((a, b) => b.revenue - a.revenue) // Sắp xếp theo doanh thu
                .slice(0, 10); // Lấy top 10 Marketer

            // Tạo biểu đồ
            Highcharts.chart('adPerformanceChart', {
                chart: {
                    type: 'column',
                    backgroundColor: document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF',
                    height: 500
                },
                title: {
                    text: 'Hiệu suất theo Marketer',
                    style: {
                        color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                    }
                },
                xAxis: {
                    categories: chartData.map(item => item.marketer),
                    labels: {
                        rotation: -45,
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    }
                },
                yAxis: [{
                    // Trục cho Clicks
                    title: {
                        text: 'Số lượng Clicks',
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    },
                    labels: {
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    }
                }, {
                    // Trục cho Revenue
                    title: {
                        text: 'Revenue',
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    },
                    opposite: true,
                    labels: {
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        },
                        formatter: function () {
                            return this.value.toFixed(2);
                        }
                    }
                }],
                tooltip: {
                    shared: true,
                    formatter: function () {
                        return `<b>Marketer: ${this.x}</b><br/>` +
                            `Click1: ${Highcharts.numberFormat(this.points[0].y, 0)}<br/>` +
                            `Click3: ${Highcharts.numberFormat(this.points[1].y, 0)}<br/>` +
                            `Revenue: ${Highcharts.numberFormat(this.points[2].y, 2)}`;
                    }
                },
                plotOptions: {
                    column: {
                        grouping: true,
                        shadow: false,
                        borderWidth: 0
                    },
                    series: {
                        animation: {
                            duration: 1000
                        }
                    }
                },
                series: [{
                    name: 'Click1',
                    color: '#60A5FA',
                    data: chartData.map(item => item.click1),
                    type: 'column'
                }, {
                    name: 'Click3',
                    color: '#34D399',
                    data: chartData.map(item => item.click3),
                    type: 'column'
                }, {
                    name: 'Revenue',
                    color: '#F87171',
                    data: chartData.map(item => item.revenue),
                    type: 'spline',
                    yAxis: 1,
                    marker: {
                        lineWidth: 2,
                        lineColor: '#F87171',
                        fillColor: 'white'
                    }
                }],
                legend: {
                    itemStyle: {
                        color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                    }
                },
                credits: {
                    enabled: false
                }
            });
        }

        function updateEnhancedCvrChart() {
            // Calculate daily metrics
            const dailyMetrics = filteredData.reduce((acc, item) => {
                const date = item.Date;
                if (!acc[date]) {
                    acc[date] = {
                        conversions: 0,
                        clicks: 0,
                        metrics: {
                            cvr: 0,
                            cpa: 0,
                            rpc: 0,
                            cost: 0
                        }
                    };
                }
                // Sử dụng trực tiếp các giá trị số thập phân
                acc[date].metrics.cvr = parseFloat(item.CVR || 0);
                acc[date].metrics.cpa = parseFloat(item.CPA || 0);
                acc[date].metrics.rpc = parseFloat(item.RPC || 0);
                acc[date].metrics.cost = parseFloat(item.Cost || 0);
                acc[date].clicks = parseFloat(item.Click1 || 0);
                return acc;
            }, {});

            // Transform data for the chart
            const chartData = Object.entries(dailyMetrics)
                .map(([date, data]) => ({
                    date: date,
                    cvr: data.metrics.cvr,
                    cpa: data.metrics.cpa,
                    rpc: data.metrics.rpc,
                    cost: data.metrics.cost,
                    clicks: data.clicks
                }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            // Calculate moving averages
            const movingAverages = calculateMovingAverages(chartData, 7);

            // Create the chart
            Highcharts.chart('cvrChart', {
                chart: {
                    type: 'line',
                    backgroundColor: document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF'
                },
                title: { text: null },
                xAxis: {
                    categories: chartData.map(item => item.date),
                    labels: {
                        rotation: -45,
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    }
                },
                yAxis: [{
                    title: {
                        text: 'Conversion Rate (%)',
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    },
                    labels: {
                        format: '{value:.2f}%',
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    }
                }, {
                    title: {
                        text: 'Metrics',
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    },
                    opposite: true,
                    labels: {
                        format: '{value:.2f}',
                        style: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                        }
                    }
                }],
                tooltip: {
                    shared: true,
                    formatter: function () {
                        const point = chartData[this.points[0].point.index];
                        return `<b>${this.x}</b><br/>
                    CVR: ${point.cvr.toFixed(2)}%<br/>
                    Clicks: ${point.clicks}<br/>
                    CPA: ${point.cpa.toFixed(2)}<br/>
                    RPC: ${point.rpc.toFixed(2)}<br/>
                    Cost: ${point.cost.toFixed(2)}<br/>
                    7-Day Avg CVR: ${movingAverages[this.x]?.toFixed(2) || 0}%`;
                    }
                },
                legend: {
                    itemStyle: {
                        color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#374151'
                    }
                },
                series: [{
                    name: 'Daily CVR',
                    data: chartData.map(item => item.cvr),
                    color: '#60A5FA',
                    tooltip: {
                        valueDecimals: 2,
                        valueSuffix: '%'
                    }
                }, {
                    name: '7-Day Moving Average',
                    data: Object.values(movingAverages),
                    color: '#34D399',
                    lineWidth: 2,
                    marker: { radius: 0 }
                }, {
                    name: 'CPA',
                    data: chartData.map(item => item.cpa),
                    yAxis: 1,
                    color: '#F87171',
                    visible: false
                }, {
                    name: 'RPC',
                    data: chartData.map(item => item.rpc),
                    yAxis: 1,
                    color: '#10B981',
                    visible: false
                }, {
                    name: 'Cost',
                    data: chartData.map(item => item.cost),
                    yAxis: 1,
                    color: '#9333EA',
                    visible: false
                }]
            });
        }

        // Helper function for calculating moving averages
        function calculateMovingAverages(data, period) {
            const averages = {};
            for (let i = 0; i < data.length; i++) {
                if (i >= period - 1) {
                    const slice = data.slice(i - period + 1, i + 1);
                    const average = slice.reduce((sum, item) => sum + item.cvr, 0) / period;
                    averages[data[i].date] = average;
                }
            }
            return averages;
        }


        // Update campaign table
        function updateCampaignTable() {
            const tableBody = document.querySelector('#campaignTable tbody');
            tableBody.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            paginatedData.forEach(campaign => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${campaign.AdID}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${campaign.Marketer}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${campaign['Traffic Source']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${campaign.Link || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatCurrency(campaign['Cost VND'])}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatCurrency(campaign['Revenue VND'])}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${parseFloat(campaign.ROI).toFixed(2)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${campaign.Status === 'Active' ? 'bg-green-100 text-green-800' :
                        campaign.Status === 'Paused' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'}">
                            ${campaign.Status}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Trang ${currentPage} / ${totalPages}`;

            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');

            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;

            prevButton.classList.toggle('opacity-50', currentPage === 1);
            nextButton.classList.toggle('opacity-50', currentPage === totalPages);
        }

        // Charts
        function updateCharts() {
            updateRevenueChart();
            updateMarketerChart();
            updateTrafficChart();
            updateEnhancedCvrChart();
            createAdPerformanceChart();
        }

        // Chart update functions
        function updateRevenueChart() {
            const previousPeriodData = calculatePreviousPeriodData(filteredData);

            // Xử lý dữ liệu hiện tại
            const currentDailyData = filteredData.reduce((acc, item) => {
                const date = item.Date.split(' ')[0];
                if (!acc[date]) acc[date] = { cost: 0, revenue: 0 };
                acc[date].cost += parseFloat(item['Cost VND'] || 0);
                acc[date].revenue += parseFloat(item['Revenue VND'] || 0);
                return acc;
            }, {});

            // Xử lý dữ liệu kỳ trước
            const previousDailyData = previousPeriodData.reduce((acc, item) => {
                const date = item.Date.split(' ')[0];
                if (!acc[date]) acc[date] = { cost: 0, revenue: 0 };
                acc[date].cost += parseFloat(item['Cost VND'] || 0);
                acc[date].revenue += parseFloat(item['Revenue VND'] || 0);
                return acc;
            }, {});

            // Cấu hình biểu đồ với thêm series cho kỳ trước
            Highcharts.chart('revenueChart', {
                chart: { type: 'line' },
                title: { text: null },
                xAxis: {
                    categories: Object.keys(currentDailyData).sort(),
                    labels: { rotation: -45 }
                },
                yAxis: {
                    title: { text: null },
                    labels: {
                        formatter: function () {
                            if (this.value >= 1000000000) return (this.value / 1000000000) + 'B';
                            if (this.value >= 1000000) return (this.value / 1000000) + 'M';
                            if (this.value >= 1000) return (this.value / 1000) + 'K';
                            return this.value;
                        }
                    }
                },
                series: [
                    {
                        name: 'Chi phí',
                        data: Object.values(currentDailyData).map(d => d.cost),
                        color: '#EF4444'
                    },
                    {
                        name: 'Doanh thu',
                        data: Object.values(currentDailyData).map(d => d.revenue),
                        color: '#10B981'
                    },
                    {
                        name: 'Chi phí (Kỳ trước)',
                        data: Object.values(previousDailyData).map(d => d.cost),
                        color: '#FCA5A5',
                        dashStyle: 'shortdash'
                    },
                    {
                        name: 'Doanh thu (Kỳ trước)',
                        data: Object.values(previousDailyData).map(d => d.revenue),
                        color: '#6EE7B7',
                        dashStyle: 'shortdash'
                    }
                ]
            });
        }

        function updateMarketerChart() {
            const marketerStats = filteredData.reduce((acc, item) => {
                const marketer = item.Marketer;
                if (!acc[marketer]) {
                    acc[marketer] = { revenue: 0, profit: 0 };
                }
                acc[marketer].revenue += parseFloat(item['Revenue VND'] || 0);
                acc[marketer].profit += parseFloat(item['Revenue VND'] || 0) - parseFloat(item['Cost VND'] || 0);
                return acc;
            }, {});

            const chartData = Object.entries(marketerStats)
                .map(([marketer, stats]) => ({
                    name: marketer,
                    revenue: stats.revenue,
                    profit: stats.profit
                }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);

            Highcharts.chart('marketerChart', {
                chart: { type: 'column' },
                title: { text: null },
                xAxis: {
                    categories: chartData.map(d => d.name),
                    labels: {
                        style: {
                            fontSize: '11px'
                        }
                    }
                },
                yAxis: {
                    title: { text: null },  // Removed VND label
                    labels: {
                        formatter: function () {
                            // Format numbers in millions/billions without VND
                            if (this.value >= 1000000000) {
                                return (this.value / 1000000000).toFixed(1) + 'B';
                            } else if (this.value >= 1000000) {
                                return (this.value / 1000000).toFixed(1) + 'M';
                            } else if (this.value >= 1000) {
                                return (this.value / 1000).toFixed(1) + 'K';
                            }
                            return this.value;
                        }
                    }
                },
                tooltip: {
                    formatter: function () {
                        return `<b>${this.x}</b><br/>
                        ${this.series.name}: ${formatCurrency(this.y)}`;
                    }
                },
                series: [
                    {
                        name: 'Doanh thu',
                        data: chartData.map(d => d.revenue),
                        color: '#10B981'
                    },
                    {
                        name: 'Lợi nhuận',
                        data: chartData.map(d => d.profit),
                        color: '#3B82F6'
                    }
                ]
            });
        }

        function updateTrafficChart() {
            // Tính tổng traffic từ mỗi nguồn
            const trafficStats = filteredData.reduce((acc, item) => {
                const source = item['Traffic Source'] || 'Unknown';
                if (!acc[source]) {
                    acc[source] = {
                        traffic: 0,
                        cost: parseFloat(item['Cost VND'] || 0),
                        conversions: parseFloat(item['Conversions'] || 0)
                    };
                }
                // Sử dụng Click1 làm lượng traffic
                acc[source].traffic += parseFloat(item['Click1'] || 0);
                acc[source].cost += parseFloat(item['Cost VND'] || 0);
                acc[source].conversions += parseFloat(item['Conversions'] || 0);
                return acc;
            }, {});

            // Chuyển đổi dữ liệu cho biểu đồ
            const chartData = Object.entries(trafficStats)
                .map(([source, stats]) => ({
                    name: source,
                    y: stats.traffic, // Sử dụng lượng traffic làm giá trị chính
                    percentage: 0, // Sẽ được tính toán sau
                    cost: stats.cost,
                    conversions: stats.conversions
                }));

            // Tính tổng traffic
            const totalTraffic = chartData.reduce((sum, item) => sum + item.y, 0);

            // Tính phần trăm cho mỗi nguồn
            chartData.forEach(item => {
                item.percentage = (item.y / totalTraffic * 100);
            });

            // Sắp xếp theo lượng traffic từ cao đến thấp
            chartData.sort((a, b) => b.y - a.y);

            // Cấu hình biểu đồ
            Highcharts.chart('trafficChart', {
                chart: {
                    type: 'pie',
                    backgroundColor: document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF'
                },
                title: { text: null },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f}%',
                            style: {
                                color: document.documentElement.classList.contains('dark') ? '#FFFFFF' : '#000000'
                            }
                        }
                    }
                },
                tooltip: {
                    formatter: function () {
                        return `<b>${this.point.name}</b><br/>
                        Traffic: ${Math.round(this.point.y).toLocaleString()} clicks<br/>
                        Tỷ lệ: ${this.point.percentage.toFixed(1)}%<br/>
                        Chi phí: ${formatCurrency(this.point.cost)}<br/>
                        Conversions: ${this.point.conversions}`;
                    }
                },
                series: [{
                    name: 'Traffic Source',
                    colorByPoint: true,
                    data: chartData
                }]
            });
        }
        // Export function
        function exportToExcel() {
            const headers = ['AdID', 'Marketer', 'Traffic Source', 'Link', 'Date', 'Cost VND', 'Revenue VND', 'ROI', 'Status'];

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += headers.join(",") + "\n";

            filteredData.forEach(item => {
                const row = [
                    item.AdID,
                    item.Marketer,
                    item['Traffic Source'],
                    item.Link || '',
                    item.Date,
                    item['Cost VND'],
                    item['Revenue VND'],
                    item.ROI,
                    item.Status
                ];
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `ads_report_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event Listeners
        function setupEventListeners() {
            // Date filter events
            document.getElementById('dateFilter').addEventListener('change', function (e) {
                const customDateRange = document.getElementById('customDateRange');
                if (e.target.value === 'custom') {
                    customDateRange.classList.remove('hidden');
                } else {
                    customDateRange.classList.add('hidden');
                    applyFilters();
                }
            });

            // Filter events
            document.getElementById('marketerFilter').addEventListener('change', applyFilters);
            document.getElementById('trafficSourceFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('linkFilter').addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('startDate').addEventListener('change', applyFilters);
            document.getElementById('endDate').addEventListener('change', applyFilters);

            // Filter buttons
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);

            // Pagination
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateCampaignTable();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateCampaignTable();
                }
            });

            // Search
            document.getElementById('campaignSearch').addEventListener('input', debounce((e) => {
                const searchTerm = e.target.value.toLowerCase();
                filteredData = allData.filter(campaign =>
                    campaign.AdID.toLowerCase().includes(searchTerm) ||
                    campaign.Marketer.toLowerCase().includes(searchTerm) ||
                    campaign['Traffic Source'].toLowerCase().includes(searchTerm) ||
                    (campaign.Link || '').toLowerCase().includes(searchTerm) ||
                    campaign.Status.toLowerCase().includes(searchTerm)
                );
                currentPage = 1;
                updateDashboard();
            }, 300));

            // Export
            document.getElementById('exportData').addEventListener('click', exportToExcel);

            // Dark mode
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('marketerFilter').value = '';
            document.getElementById('trafficSourceFilter').value = '';
            document.getElementById('dateFilter').value = 'all';
            document.getElementById('statusFilter').value = '';
            document.getElementById('linkFilter').value = '';
            document.getElementById('customDateRange').classList.add('hidden');
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            filteredData = allData;
            currentPage = 1;
            updateDashboard();
        }

        // Dark mode functions
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            updateDarkModeIcon();
            updateCharts();
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        }

        function updateDarkModeIcon() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const isDarkMode = document.documentElement.classList.contains('dark');
            darkModeToggle.innerHTML = isDarkMode
                ? '<i class="fas fa-sun text-yellow-300"></i>'
                : '<i class="fas fa-moon text-gray-800"></i>';
        }

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setupEventListeners();

            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                updateDarkModeIcon();
            }
        });
    </script>
</body>

</html>